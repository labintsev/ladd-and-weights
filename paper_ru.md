# Исследование соотношение точности и производительности моделей yolo8 на специальном наборе данных 

## Аннотация 
В статье представлен набор данных  под названием Lacmus. 
Датасет предназначен для решения задачи детекции объектов, а конкретно - поиска пропавших людей на снимках, сделанных с помощью беспилотника. 
Набор данных Lacmus содержит более 5000 размеченных боксов на 1552 изображениях.
Объекты имеют один класс - это потерявшиеся люди, которые находятся на местности в траве или редком лесу. 
Съемки проводились в 5 разных локациях, в разные времена года. 
Целью исследования является поиск оптимального соотношения точности и производительности моделей yolo 8 для дальнейшего использования в реальном приложении. 
Мы обнаружили, что наилучшее соотношение дает модель среднего размера с большим размером входных изображений без нарезки на части. 
Мы надеемся, что собранные данные и проведенное исследование поможет спасти жизни пропавших без вести людей. 

## Введение
Каждый год на местности пропадает множество людей. 
Значительная часть из них - это люди, которые заблудились вдали от человеческого жилья. 
К счастью, некоторые из заблудившихся выбираются сами, но для тех кто не смог, мобилизуются добровольческие поисково-спасательные команды. 
Тема актуальная, множество идей воплощены в виде прототипов и апробированы на специально организованных конкурсах. 
Но в лесу реальные условия поиска в сочетании с ограниченными материальными ресурсами делают эту проблему сложной и все еще очень далекой от успешного решения. 
В последние годы спасатели все чаще используют беспилотные летательные аппараты (БПЛА) для обследования больших участков территории, фотографируя местность с высоты 40-50 м. 
В результате одной поисково-спасательной операции получается несколько тысяч фотографий, которые сегодня волонтеры просматривают вручную. 
Понятно, что такая обработка является длительной и неэффективной, после двух часов такой работы волонтеры устают и не могут продолжать поиски. 
Однако от скорости и точности обработки снимков зависят здоровье и жизни людей. 
Фонд Lacmus совместно с поисково-спасательными командами разрабатывает приложение для поиска пропавших людей по снимкам, сделанным с БПЛА. 

## Обзор проведенных исследований 
Известная задача в области компьютерного зрения - детекция объектов. 
Методы детекции объектов разрабатываются уже более 50 лет [Herskovits 1970, Yakimovsky 1976]. 
В наши дни для обработки изображений используются различные архитектуры нейросетей. 
Исторически принято выделять два вида детекторов - одного уровня и двух уровневые. 
Детекторы one-stage сегодня применяются чаще из-за хорошего соотношения точности и скорости [Carranza-García 2020]. 
Кроме того, известны вычислительно более сложные архитектуры на базе трансформеров [Shehzadi 2023]. 
Очень эффективной техникой повышения точности предсказания является метод скользящего окна SAHI [Akyon 2022]. 
Однако расплатой за повышение точности является повышение вычислительных затрат, особенно на обработку изображений высокого разрешеня. 

Наиболее популярными бенчмарками для сравнения различных архитектур детекции объектов являются COCO [Lin 2014] и Pascal Voc [Everingham 2010].     
Эти датасеты имеют большое количество размеченных изображений, к сожалению, не релевантных нашей специальной задаче.  
Набор данных VisDrone [Zhu, 2018] в настоящее время широко используется для оценки обнаружения объектов беспилотными летательными аппаратами (БПЛА). 
Набор данных содержит 10 209 изображений, из которых 6471 изображение предназначено для обучения, 548 изображений - для валидации и 3190 изображений - для тестирования. 
Он охватывает 10 категорий объектов: люди и различные виды техники: велосипеды, автомобили, грузовики и т.д.. 
Большинство снимков сделано в городском контексте, что затрудняет применение этих снимков для обучений нейросетей для спасательных операций в лесу. 
Набор данных UAVDT [Du, 2018] собран для задач отслеживания объектов, содержит изображения разрешением 1024 × 540 пикселей и общим количеством 80 000 кадров из 100 видеороликов. 
Каждый кадр содержит три класса объектов: автомобили, автобусы и грузовики. 
Датасет также имеет специфику для решения задачи объектов в городской среде и не подходит для детекции людей в лесу. Набор данных SeaDronesSee [Varga 2022]  предназначен для разработки систем поиска и спасания (SAR) с использованием беспилотных летательных аппаратов (БПЛА) в морских условиях. 
Этот набор данных позволяет тренировать нейросети для решения трех задач: детекция объектов, отслеживание отдельных объектов и отслеживание нескольких объектов. 
Для детекции объектов доступно 5630 изображений в обучающей выборки, 859 изображений для проверки и 1796 изображений для тестирования. 
Специфику лесных ПСО хорошо отражает специальная база данных под названием HERIDAL [Božić-Štulić, 2019]. 
Он содержит более 68 750 изображений в природном ландшафте, полученных с высоты птичьего полета, а также 500 размеченных полноразмерных изображений, предназначенных для тестирования. 
База данных HERIDAL использовалась для обучения и тестирования различных архитектур, включая оригинальную нейросеть, предложенную авторами.
В этом исследовании полнота обнаружения составила 88,9%, а точность - 34,8%.
Датасет SARD [Sasa 2024] содержит 1981 размеченных изображение, извлеченное из видеокадров, на которых люди имитируют поисково-спасательные операции на дорогах, в карьерах, на лугах и в лесных массивах в различных погодных условиях. 
Набор данных WiSARD [Broyles, 2022] содержит самый богатый набор изображений, связанных со сценариями SAR в дикой природе. 
Он содержит 33 786 изображений с маркировкой RGB, 22 156 тепловых изображений с маркировкой и подмножество, состоящее из 15 453 синхронизированных во времени пар визуальных и тепловых изображений. 
В дополнение к полезным мультимодальным изображениям, набор данных включает в себя разнообразие окружающей среды в зависимости от сезона и времени дня и ночи. 
Также известен набор данных NOMAD, в котором собраны снимки с различной степенью затененности объектов и высоты полета БПЛА [Russel Bernal, 2024] 
При создании датасета 100 различных актеров исполняли различные сценарии хождения, лежания и прятания. 
Набор включает в себя 42 825 кадров, извлеченных из видео с разрешением более 5000 пикселей.
Аннотации включают в себя боксы объектов и описание уровня видимости, в соответствии с процентной долей человеческого тела, видимой внутри рамки. 
Такая разметка позволяет оценивать эффективность обнаружения с помощью моделей компьютерного зрения при различных уровнях видимости объекта. 
NOMAD разработан для повышения эффективности ПСО, однако отсутствует в свободном доступе.

Таким образом, проанализировав различные наборы данных, можно выделить следующие особенности задачи детекции объектов в спасательных операциях [Du 2018]: 
- Объекты одного класса. Как правило, наибольший интерес в поиске представляют люди. Остальные классы объектов тоже могут присутствовать, но их обнаружение является скорее исключением из правил. 
- Высокое разрешение снимков. На большой высоте количество пикселей играет очень важную роль. Чем выше разрешение снимка, тем больше пикселей будет приходиться на один объект. Хорошим числом можно считать 100 на 100 пикселей. В этом случае изображение объекта содержит достаточное количество информации для его детектирования.  
- Малый размер объектов. Чем выше высота полета, тем меньшую площадь человек будет занимать на снимке. Даже в лучшем случае, площадь человека занимает менее 1% от общей площади изображения.     
- Движение камеры. Чем выше скорость движения БпЛА, тем более смазанным получается изображение. В этом случае приходится жертвовать выдержкой, что тоже снижает качество фотографии. Кроме того, постоянно меняющееся положение камеры дает разные ракурсы для одного объекта. Это значит, что модель детекции должна иметь достаточно высокую обобщающую способность. 
- Ограниченное время для обработки снимков. Большое количество информации требует больших затрат для обработки. Мощные компьютеры с современными видеокартами не всегда доступны отрядам спасателей. Поэтому чем эффективнее будет работать алгоритм детекции, тем меньше времени понадобится для обнаружения пропавшего человека и его спасения.  

Актуальной темой является повышение точности прогнозирования для небольших объектов.  
Очень эффективным методом для решения этой задачи является метод окна Slicing Aided HyperInference (SAHI) [Akyon 2022]. 
Однако за повышение точности приходится расплачиваться увеличением вычислительных затрат, особенно при обработке изображений с высоким разрешением.
Известен также адаптивный метод для сокращения ненужных вычислений [Zhang 2023]. 
Однако вопрос о выборе оптимального размера окна и модели для детекции остается открытым.  

Командой Lacmus Foundation разрабатываются приложения для спасательных отрядов, которые работают на стационарных и мобильных платформах. 
Целью нашего исследования является поиск лучшего баланса между скоростью и точностью предсказания. 
Этот вопрос имеет большое значение, т.к. наши приложения уже успешно используются в реальных спасательных операциях.  
## Методы исследования

Для сбора данных проводились учебные поисково-спасательные операции. 
Команда добровольцев выезжала на местность и находилась там в различных позах. 
Эти позы соответствовали тому, как были найдены рельно пропавшие люди. 
Мы использовали одежду разных цветов, а также местность с различным количеством деревьев: 
- чистое поле;
- не густой лес.

Всего было проведено 5 учебных съемок в разное время года: весна, лето и зима. 
Для исследования соотношения скорости и точности мы создали дополнительно два датасета путем разделения исходных изображений на несколько частей: 
- 2x1 - разделение на 2 части по ширине. Это дало нам 2844 изображения для обучения и 260 для тестирования. 
- 3x2 - разделение на 6 частей - 3 по ширине и 2 по высоте. Это дало нам 5688 изображений для обучения и 520 для тестирования.
- 1x1 - без разделения на части.
  
Те кропы, на которых не было людей, мы просто отбрасывали. 
Таким образом, в нашем распоряжении имеется три разных варианта одинаковых данных, с разным соотношением площади объектов к площади изображения.  
Такой прием позволяет оценить точность детекции объектов при разных уровнях разрешения изображений. 
Максимальное сжатие будет в том случае, когда исходное изображение будет сжиматься до размера модели 640 на 640. 
Минимальные потери от сжатия будут в датасете 3x2 и входном размере модели 1984 на 1984.  

В качестве метрик точности мы используем precision and recall. 
Бокс считается объектом, если вероятность классификации выше заданного порога. 
Объект считается верно найденным, если величина IoU превышает заданный порог. 

$$
\displaystyle IoU = \frac{B_t \cap B_p}{B_t \cup B_p}
$$

Precision отражает величину ошибок первого рода, или долю объектов, ошибочно принятых за человека. 

$$
\displaystyle Precision = \frac{TP}{TP + FP}
$$

Recall отражает величину ошибок второго рода, или долю объектов (людей), которые алгоритм не смог обнаружить. 

$$
\displaystyle Recall = \frac{TP}{TP + FN}
$$

Мы считаем, что в задаче поиска пропавших людей Recall имеет большее значение. 
Оператор может увидеть большое количество ложных срабатываний детектора и просто пропустить их. 
Однако если детектор пропустит человека, оператор тоже скорее всего его не увидит. 

В качестве метрик скорости мы используем время предсказания на CPU и GPU в милисекундах. 
Спасибо создателям фреймворка ultralitics за то, что реализовали функционал для замера производительности моделей. 

В качестве моделей для наших экспериментов использовалась yolov8. 
Упрощенная архитектура нейросети приведена на рисунке 

![Архитектура yolo](doc/5.png)

Основными особенностями yolo8 являются: 
- SPPF
- C2F
- SPF 

Мы использовали три основных модели с различным количеством сверточных слоев и максимальным количеством сверточных фильтров: 
- yolo v8 nano - 225 слоев, 1024 фильтров,  3.2 M параметров;
- yolo v8 medium - 295 слоев, 768 фильтров, 25.9 M параметров;
- yolo v8 xlarge - 365 слоев, 512 фильтров, 68.2 M параметров.

Для каждой из трех моделей мы используем различные размеры входного изображения. 
Чем больше размер входа ImgSize, тем больше вычислений нужно произвести и больше количество боксов на выходе модели 
Для представленной архитектуры yolo8 можно воспользоваться эмпирической формулой: 

$$
\displaystyle NumBoxes = \frac{21}{1024}\cdot{ImgSize}^2
$$

Таким образом, каждая из трех моделей используется с тремя разными размерами входных изображений: 
- 640 px - 8400 боксов, 
- 1280 px - 33600 боксов, 
- 1984 px - 80724 боксов. 

Кроме того, для оценки влияния размеров скользящего окна мы используем три датасета с разным соотношением площади объектов и изображения:
- без нарезки - 1 : 1200;
- 2х1 - 1 : 600;
- 3х2 - 1 : 200.

## Результаты

Для экспериментов использовалась машина со следующими характеристиками:
- CPU Ryzen 5 2700 RAM 32 GB;
- GPU RTX3090 RAM 24 GB.
- Ubuntu 24.04, python 3.9, ultralitics 8.2.28.

Для инференса на GPU мы не использовали оптимизации, размер батча определялся автоматически для заполнения памяти на уровне 70%. 
Представленная задержка включает в себя затраты на непосредственно инференс и постобработку NMS [Hosang 2017]. 
Время предварительной обработки изображений не учитывалось. 
Для инференса на CPU модели были оптимизированы с помощью python модуля onnx с параметрами по умолчанию. 

Результаты исследования представлены в таблицах 1-3.

Yolo 8n Precision / Recall, %

| input size | No crops | Crops 2x1 | Crops 3x2 | CPU infer, ms | GPU infer, ms | 
|------------|----------|-----------|-----------|---------------|---------------|
| 640        | 20 / 23  | 30 / 28   | 26 / 40   | 68            | 10            |   
| 1280       | 29 / 27  | 34 / 40   | 43 / 42   | 250           | 13            |   
| 1984       | 36 / 35  | 37 / 41   | 45 / 49   | 700           | 20            |   


Yolo 8m  Precision / Recall, % 

| input size | No crops | Crops 2x1 | Crops 3x2 | CPU infer,  ms | GPU infer, ms | 
|------------|----------|-----------|-----------|----------------|---------------|
| 640        | 27 / 28  | 30 / 32   | 41 / 42   | 360            | 18            |   
| 1280       | 34 / 35  | 38 / 37   | 46 / 50   | 1500           | 23            |   
| 1984       | 40 / 41  | 45 / 42   | 50 / 50   | 3600           | 44            |   


Yolo 8x  Precision / Recall, % 

| input size | No crops | Crops 2x1 | Crops 3x2 | CPU infer, ms | GPU infer, ms | 
|------------|----------|-----------|-----------|---------------|---------------|
| 640        | 24 / 24  | 32 / 29   | 34 / 40   | 1050          | 21            |   
| 1280       | 33 / 29  | 35 / 35   | 44 / 38   | 4400          | 37            |   
| 1984       | 43 / 35  | 37 / 41   | 45 / 47   | 10800         | 93            |   


## Обсуждение

Самой точной моделью является - 
Самой быстрой моделью является 
При обработке изображений на GPU наиболее эффективно будет использовать батчи изображений для максимальной загрузки памяти GPU. 
Для этих целей наиболее предпочтительна схема - 
При работе на CPU наиболее предпочтительна схема - 
Таким образом, в реальных приложениях нужно учитывать какой процессор будет использован пользователем. 
Исходя из этого следует задействовать лучшую модель с лучшим количеством скользящих окон. 

## Заключение 


## Ссылки

